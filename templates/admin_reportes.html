{% extends "base.html" %}

{% block title %}Reportes de Usuarios - Vigia{% endblock %}

{% block page_title %}Reportes de Usuarios{% endblock %}
{% block page_subtitle %}Gestionar y revisar reportes de usuarios autorizados{% endblock %}

{% block breadcrumb %}
<li><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
<li class="active">Reportes de Usuarios</li>
{% endblock %}

{% block content %}

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<!-- Estadísticas -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="info-box bg-info">
            <span class="info-box-icon"><i class="bi bi-list-ul"></i></span>
            <div class="info-box-content">
                <span class="info-box-text">Total Reportes</span>
                <span class="info-box-number">{{ total_reportes }}</span>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="info-box bg-warning">
            <span class="info-box-icon"><i class="bi bi-clock-history"></i></span>
            <div class="info-box-content">
                <span class="info-box-text">Pendientes</span>
                <span class="info-box-number">{{ reportes_pendientes }}</span>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="info-box bg-primary">
            <span class="info-box-icon"><i class="bi bi-eye"></i></span>
            <div class="info-box-content">
                <span class="info-box-text">En Revisión</span>
                <span class="info-box-number">{{ reportes_en_revision }}</span>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="info-box bg-success">
            <span class="info-box-icon"><i class="bi bi-check-circle"></i></span>
            <div class="info-box-content">
                <span class="info-box-text">Resueltos</span>
                <span class="info-box-number">{{ reportes_resueltos }}</span>
            </div>
        </div>
    </div>
</div>

<!-- Tabla de Reportes -->
<div class="row">
    <div class="col-md-12">
        <div class="box box-primary">
            <div class="box-header with-border">
                <h3 class="box-title"><i class="bi bi-list-ul"></i> Todos los Reportes</h3>
            </div>
            <div class="box-body">
                {% if reportes %}
                <div class="table-responsive">
                    <table class="table table-hover table-striped">
                        <thead>
                            <tr>
                                <th>Imagen</th>
                                <th>Usuario</th>
                                <th>Fecha/Hora</th>
                                <th>Tipo</th>
                                <th>Ubicación</th>
                                <th>Descripción</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for reporte in reportes %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('usuario_imagen', filename=reporte.imagen) }}" target="_blank">
                                        <img src="{{ url_for('usuario_imagen', filename=reporte.imagen) }}" 
                                             alt="Reporte" 
                                             style="width: 100px; height: 100px; object-fit: cover; border-radius: 4px; cursor: pointer;">
                                    </a>
                                </td>
                                <td>
                                    <strong>{{ reporte.usuario_nombre or 'Usuario eliminado' }}</strong><br>
                                    <small class="text-muted">{{ reporte.usuario_correo or '' }}</small>
                                </td>
                                <td>
                                    {{ reporte.fecha_hora.split('T')[0] if 'T' in reporte.fecha_hora else reporte.fecha_hora.split(' ')[0] }}<br>
                                    <small>{{ reporte.fecha_hora.split('T')[1].split('.')[0] if 'T' in reporte.fecha_hora else (reporte.fecha_hora.split(' ')[1] if ' ' in reporte.fecha_hora else '') }}</small>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ reporte.tipo_reporte }}</span>
                                </td>
                                <td>{{ reporte.ubicacion or 'No especificada' }}</td>
                                <td>
                                    <span title="{{ reporte.descripcion or 'Sin descripción' }}">
                                        {{ (reporte.descripcion or 'Sin descripción')[:50] }}{% if reporte.descripcion and reporte.descripcion|length > 50 %}...{% endif %}
                                    </span>
                                </td>
                                <td>
                                    {% if reporte.estado == 'pendiente' %}
                                        <span class="badge bg-warning">Pendiente</span>
                                    {% elif reporte.estado == 'en_revision' %}
                                        <span class="badge bg-info">En Revisión</span>
                                    {% elif reporte.estado == 'resuelto' %}
                                        <span class="badge bg-success">Resuelto</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ reporte.estado }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <form method="POST" action="{{ url_for('cambiar_estado_reporte') }}" style="display: inline;">
                                        <input type="hidden" name="reporte_id" value="{{ reporte.id }}">
                                        <select name="nuevo_estado" class="form-select form-select-sm" onchange="this.form.submit()">
                                            <option value="pendiente" {% if reporte.estado == 'pendiente' %}selected{% endif %}>Pendiente</option>
                                            <option value="en_revision" {% if reporte.estado == 'en_revision' %}selected{% endif %}>En Revisión</option>
                                            <option value="resuelto" {% if reporte.estado == 'resuelto' %}selected{% endif %}>Resuelto</option>
                                        </select>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> No hay reportes registrados aún.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

