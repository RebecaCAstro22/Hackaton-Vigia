{% extends "base.html" %}

{% block title %}Mi Perfil - Vigia{% endblock %}

{% block page_title %}Mi Perfil{% endblock %}
{% block page_subtitle %}Información Personal y Configuración{% endblock %}

{% block breadcrumb %}
<li class="active">Mi Perfil</li>
{% endblock %}

{% block content %}

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<!-- Estadísticas del Usuario -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="info-box bg-info">
            <span class="info-box-icon"><i class="bi bi-bell"></i></span>
            <div class="info-box-content">
                <span class="info-box-text">Total Alertas</span>
                <span class="info-box-number">{{ total_alertas_sistema }}</span>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="info-box bg-warning">
            <span class="info-box-icon"><i class="bi bi-clock-history"></i></span>
            <div class="info-box-content">
                <span class="info-box-text">Alertas (24h)</span>
                <span class="info-box-number">{{ alertas_24h }}</span>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="info-box bg-danger">
            <span class="info-box-icon"><i class="bi bi-exclamation-triangle"></i></span>
            <div class="info-box-content">
                <span class="info-box-text">Críticas (24h)</span>
                <span class="info-box-number">{{ alertas_criticas_24h }}</span>
            </div>
        </div>
    </div>
</div>

<!-- Información Personal -->
<div class="row">
    <div class="col-md-6">
        <div class="box box-primary">
            <div class="box-header with-border">
                <h3 class="box-title"><i class="bi bi-person"></i> Información Personal</h3>
            </div>
            <div class="box-body">
                <table class="table table-borderless">
                    <tr>
                        <th width="40%">Nombre:</th>
                        <td>{{ usuario.nombre }}</td>
                    </tr>
                    <tr>
                        <th>Correo Electrónico:</th>
                        <td>{{ usuario.correo }}</td>
                    </tr>
                    <tr>
                        <th>Fecha de Registro:</th>
                        <td>{{ usuario.fecha_registro.split('T')[0] if 'T' in usuario.fecha_registro else usuario.fecha_registro }}</td>
                    </tr>
                    <tr>
                        <th>Rol:</th>
                        <td>
                            {% if usuario.rol == 'admin' %}
                                <span class="badge badge-danger">Administrador</span>
                            {% else %}
                                <span class="badge badge-primary">Usuario</span>
                            {% endif %}
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="box box-warning">
            <div class="box-header with-border">
                <h3 class="box-title"><i class="bi bi-key"></i> Cambiar Contraseña</h3>
            </div>
            <div class="box-body">
                <form method="POST" action="{{ url_for('cambiar_contraseña') }}">
                    <div class="mb-3">
                        <label for="contraseña_actual" class="form-label">Contraseña Actual</label>
                        <input type="password" class="form-control" id="contraseña_actual" 
                               name="contraseña_actual" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="nueva_contraseña" class="form-label">Nueva Contraseña</label>
                        <input type="password" class="form-control" id="nueva_contraseña" 
                               name="nueva_contraseña" required minlength="6">
                        <small class="form-text text-muted">Mínimo 6 caracteres</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="confirmar_contraseña" class="form-label">Confirmar Nueva Contraseña</label>
                        <input type="password" class="form-control" id="confirmar_contraseña" 
                               name="confirmar_contraseña" required>
                    </div>
                    
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-key-fill"></i> Cambiar Contraseña
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Accesos Rápidos -->
<div class="row">
    <div class="col-md-12">
        <div class="box box-info">
            <div class="box-header with-border">
                <h3 class="box-title"><i class="bi bi-lightning-charge"></i> Accesos Rápidos</h3>
            </div>
            <div class="box-body">
                <div class="row">
                    {% if session.user_rol == 'admin' %}
                    <div class="col-md-3">
                        <a href="{{ url_for('dashboard') }}" class="btn btn-info btn-block mb-2">
                            <i class="bi bi-speedometer2"></i> Dashboard
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{{ url_for('analizar') }}" class="btn btn-primary btn-block mb-2">
                            <i class="bi bi-camera"></i> Analizar Imagen
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{{ url_for('alertas') }}" class="btn btn-warning btn-block mb-2">
                            <i class="bi bi-bell"></i> Ver Alertas
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{{ url_for('mapa_vigilancia') }}" class="btn btn-success btn-block mb-2">
                            <i class="bi bi-map"></i> Mapa de Vigilancia
                        </a>
                    </div>
                    {% else %}
                    <div class="col-md-6">
                        <a href="{{ url_for('usuario_alertas') }}" class="btn btn-danger btn-block mb-2">
                            <i class="bi bi-exclamation-triangle"></i> Alertas Graves
                        </a>
                    </div>
                    <div class="col-md-6">
                        <a href="{{ url_for('usuario_mapa') }}" class="btn btn-success btn-block mb-2">
                            <i class="bi bi-map"></i> Mapa
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reportar Incidente -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="box box-primary">
            <div class="box-header with-border">
                <h3 class="box-title"><i class="bi bi-camera-fill"></i> Reportar Incidente</h3>
            </div>
            <div class="box-body">
                <p>Puedes reportar incidentes capturando una imagen en tiempo real desde tu cámara.</p>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Importante:</strong> Solo puedes capturar imágenes en tiempo real desde la cámara. 
                    No se permiten imágenes guardadas en tu dispositivo.
                </div>
                <a href="{{ url_for('usuario_reportar') }}" class="btn btn-primary btn-lg">
                    <i class="bi bi-camera-fill"></i> Hacer un Reporte
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Mis Reportes -->
{% if reportes %}
<div class="row mt-4">
    <div class="col-md-12">
        <div class="box box-info">
            <div class="box-header with-border">
                <h3 class="box-title">
                    <i class="bi bi-list-ul"></i> Mis Reportes 
                    <span class="badge badge-primary">{{ total_reportes }}</span>
                </h3>
            </div>
            <div class="box-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Imagen</th>
                                <th>Fecha/Hora</th>
                                <th>Descripción</th>
                                <th>Ubicación</th>
                                <th>Tipo</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for reporte in reportes %}
                            <tr>
                                <td>
                                    <img src="{{ url_for('usuario_imagen', filename=reporte.imagen) }}" 
                                         alt="Reporte" 
                                         style="width: 80px; height: 80px; object-fit: cover; border-radius: 4px;">
                                </td>
                                <td>
                                    {{ reporte.fecha_hora.split('T')[0] if 'T' in reporte.fecha_hora else reporte.fecha_hora.split(' ')[0] }}<br>
                                    <small>{{ reporte.fecha_hora.split('T')[1].split('.')[0] if 'T' in reporte.fecha_hora else (reporte.fecha_hora.split(' ')[1] if ' ' in reporte.fecha_hora else '') }}</small>
                                </td>
                                <td>{{ reporte.descripcion or 'Sin descripción' }}</td>
                                <td>{{ reporte.ubicacion or 'No especificada' }}</td>
                                <td>
                                    <span class="badge bg-secondary">{{ reporte.tipo_reporte }}</span>
                                </td>
                                <td>
                                    {% if reporte.estado == 'pendiente' %}
                                        <span class="badge bg-warning">Pendiente</span>
                                    {% elif reporte.estado == 'en_revision' %}
                                        <span class="badge bg-info">En Revisión</span>
                                    {% elif reporte.estado == 'resuelto' %}
                                        <span class="badge bg-success">Resuelto</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ reporte.estado }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

